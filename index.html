<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canon Echo | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: #0a0f1a; color: #e2e8f0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes pulse-subtle { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .animate-pulse-subtle { animation: pulse-subtle 2s ease-in-out infinite; }
        .status-pending { color: #f59e0b; background: rgba(245, 158, 11, 0.15); }
        .status-active, .status-complete { color: #22c55e; background: rgba(34, 197, 94, 0.15); }
        .status-analyzing { color: #3b82f6; background: rgba(59, 130, 246, 0.15); }
        .drop-zone { border: 2px dashed #475569; transition: all 0.2s ease; }
        .drop-zone:hover, .drop-zone.drag-over { border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
    </style>
    <script>tailwind.config = { theme: { extend: { colors: { slate: { 850: '#162032', 950: '#0a0f1a' } } } } }</script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;
        const SUPABASE_URL = 'https://ukpniztesqiwkhazcddp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVrcG5penRlc3Fpd2toYXpjZGRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4NTA2MDAsImV4cCI6MjA4NDQyNjYwMH0.OpV9KSoVBKwO1bQYqnGiBWHilyTiTPAxxngPW30CVu0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const Icons = {
            clients: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>,
            uploads: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>,
            analyses: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
            plus: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            refresh: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
            close: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
            check: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            trash: <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            eye: <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
            dashboard: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg>,
            file: <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
            sparkles: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>,
            loader: <svg className="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" /></svg>,
            download: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
            search: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
        };
        
        const StatusBadge = ({ status }) => <span className={`px-2 py-1 rounded-full text-xs font-medium status-${status?.toLowerCase() || 'pending'}`}>{status || 'pending'}</span>;
        const StatCard = ({ title, value, icon, color }) => (<div className="bg-slate-850 border border-slate-700/50 rounded-xl p-5"><div className="flex items-center justify-between mb-3"><span className="text-slate-400 text-sm font-medium">{title}</span><div className={`p-2 rounded-lg ${color}`}>{icon}</div></div><div className="text-3xl font-bold text-white">{value}</div></div>);
        const Modal = ({ isOpen, onClose, title, children, wide }) => { if (!isOpen) return null; return (<div className="fixed inset-0 z-50 flex items-center justify-center"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div><div className={`relative bg-slate-850 border border-slate-700 rounded-2xl w-full ${wide ? 'max-w-5xl' : 'max-w-lg'} mx-4 max-h-[90vh] overflow-hidden flex flex-col animate-fade-in`}><div className="flex items-center justify-between p-5 border-b border-slate-700"><h3 className="text-lg font-semibold text-white">{title}</h3><button onClick={onClose} className="p-1 hover:bg-slate-700 rounded-lg">{Icons.close}</button></div><div className="p-5 overflow-y-auto">{children}</div></div></div>); };
        
        const AddClientForm = ({ onSubmit, onCancel }) => {
            const [formData, setFormData] = useState({ company_name: '', contact_name: '', contact_email: '', industry: '', funding_type: '', employee_count: '' });
            const handleSubmit = (e) => { e.preventDefault(); onSubmit({ ...formData, employee_count: formData.employee_count ? parseInt(formData.employee_count) : null }); };
            return (<form onSubmit={handleSubmit} className="space-y-4"><div><label className="block text-sm font-medium text-slate-300 mb-1">Company Name *</label><input type="text" required value={formData.company_name} onChange={(e) => setFormData({...formData, company_name: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="Acme Corporation" /></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-slate-300 mb-1">Contact Name</label><input type="text" value={formData.contact_name} onChange={(e) => setFormData({...formData, contact_name: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="John Smith" /></div><div><label className="block text-sm font-medium text-slate-300 mb-1">Contact Email</label><input type="email" value={formData.contact_email} onChange={(e) => setFormData({...formData, contact_email: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="john@acme.com" /></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-slate-300 mb-1">Industry</label><input type="text" value={formData.industry} onChange={(e) => setFormData({...formData, industry: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="Technology" /></div><div><label className="block text-sm font-medium text-slate-300 mb-1">Funding Type</label><select value={formData.funding_type} onChange={(e) => setFormData({...formData, funding_type: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500"><option value="">Select...</option><option value="Fully Insured">Fully Insured</option><option value="Self-Funded">Self-Funded</option><option value="Level-Funded">Level-Funded</option><option value="ASO">ASO (Self-Funded)</option></select></div></div><div><label className="block text-sm font-medium text-slate-300 mb-1">Employee Count</label><input type="number" value={formData.employee_count} onChange={(e) => setFormData({...formData, employee_count: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2.5 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" placeholder="250" /></div><div className="flex gap-3 pt-4"><button type="button" onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button><button type="submit" className="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium">Add Client</button></div></form>);
        };
        
        // Generate Complete 11-Slide Executive Report HTML
        const generateFullReportHTML = (findings, client) => {
            const f = findings || {};
            const cs = f.census_snapshot || {};
            const ra = f.risk_assessment || {};
            const gen = f.generational_breakdown || {};
            const employees = cs.total_employees || client?.employee_count || 200;
            const dependents = cs.total_dependents || Math.round(employees * 1.4);
            const totalLives = employees + dependents;
            const avgAge = cs.average_age || 42;
            const today = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const fundingType = client?.funding_type || 'Self-Funded';
            const isSelfFunded = fundingType.toLowerCase().includes('self') || fundingType.toLowerCase().includes('aso');
            const riskScore = ra.score || 55;
            const genZ = gen.gen_z_pct || 15;
            const mill = gen.millennial_pct || 25;
            const genX = gen.gen_x_pct || 35;
            const boom = gen.boomer_pct || 25;
            
            return `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Workforce Health Intelligence | ${client?.company_name} | Canon Echo</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,sans-serif;background:#000;color:#fff}
.slide{min-height:100vh;padding:60px 80px;display:flex;flex-direction:column;justify-content:center;position:relative;overflow:hidden}
.cover{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);text-align:center}
.cover .company{font-size:14px;text-transform:uppercase;letter-spacing:4px;color:#64748b;margin-bottom:40px}
.cover h1{font-size:64px;font-weight:800;line-height:1.1;margin-bottom:30px}
.cover h1 span{color:#f59e0b}
.cover .subtitle{font-size:20px;color:#94a3b8;font-weight:300}
.cover .funding-badge{display:inline-block;margin-top:30px;padding:8px 20px;background:rgba(59,130,246,0.2);border:1px solid rgba(59,130,246,0.3);border-radius:20px;font-size:12px;color:#60a5fa}
.ai-tag{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3);padding:10px 24px;border-radius:30px;font-size:12px;letter-spacing:2px;color:#f59e0b}
.mission-slide{background:linear-gradient(135deg,#1e3a5f 0%,#1e40af 100%);text-align:center}
.mission-slide h2{font-size:14px;text-transform:uppercase;letter-spacing:4px;color:rgba(255,255,255,0.5);margin-bottom:40px}
.mission-slide .quote{font-size:36px;font-weight:300;line-height:1.5;max-width:900px;margin:0 auto 50px auto}
.mission-slide .quote em{color:#f59e0b;font-style:normal}
.mission-values{display:flex;justify-content:center;gap:60px;margin-top:50px}
.mission-value{text-align:center}
.mission-value .icon{font-size:32px;margin-bottom:16px}
.mission-value h3{font-size:16px;font-weight:600;margin-bottom:8px}
.mission-value p{font-size:14px;color:rgba(255,255,255,0.6);max-width:200px}
.census-slide{background:#0f172a}
.census-slide h2,.funding-slide h2,.gen-slide h2,.risk-slide h2,.action-slide h2,.intel-slide h2{font-size:14px;text-transform:uppercase;letter-spacing:4px;color:#64748b;margin-bottom:12px}
.census-slide .headline,.funding-slide .headline,.gen-slide .headline,.risk-slide .headline,.action-slide .headline,.intel-slide .headline{font-size:42px;font-weight:800;margin-bottom:16px}
.census-slide .subhead,.funding-slide .subhead,.intel-slide .subhead{font-size:16px;color:#94a3b8;margin-bottom:40px}
.census-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:24px;margin-bottom:40px}
.census-stat{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:28px;text-align:center}
.census-stat .value{font-size:48px;font-weight:800;margin-bottom:8px}
.census-stat .value.blue{color:#3b82f6}
.census-stat .value.amber{color:#f59e0b}
.census-stat .value.green{color:#22c55e}
.census-stat .label{font-size:14px;color:#94a3b8}
.census-stat .detail{font-size:12px;color:#64748b;margin-top:8px}
.census-insight-box{background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:12px;padding:24px;display:flex;align-items:start;gap:16px}
.census-insight-box .icon{font-size:24px;flex-shrink:0}
.census-insight-box .content h4{font-size:15px;font-weight:600;margin-bottom:8px}
.census-insight-box .content p{font-size:13px;color:#94a3b8;line-height:1.5}
.funding-slide{background:#0f172a}
.funding-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:32px;margin-bottom:24px}
.funding-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.funding-type{font-size:20px;font-weight:700}
.funding-badge-green{padding:6px 14px;background:rgba(34,197,94,0.2);color:#4ade80;border-radius:20px;font-size:12px;font-weight:600}
.funding-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
.fund-box{background:rgba(255,255,255,0.03);border-radius:12px;padding:20px;text-align:center}
.fund-box .fund-amount{font-size:28px;font-weight:700;color:#4ade80;margin-bottom:8px}
.fund-box .fund-label{font-size:13px;color:#94a3b8;margin-bottom:8px}
.fund-box .fund-desc{font-size:11px;color:#64748b}
.gen-slide{background:#0f172a}
.gen-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.gen-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px}
.gen-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.gen-name{font-size:14px;font-weight:700}
.gen-pct{font-size:24px;font-weight:800}
.gen-card.genz .gen-pct{color:#a855f7}
.gen-card.millennial .gen-pct{color:#3b82f6}
.gen-card.genx .gen-pct{color:#f59e0b}
.gen-card.boomer .gen-pct{color:#ef4444}
.gen-meta{font-size:11px;color:#64748b;margin-bottom:16px}
.gen-insight{background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;margin-bottom:8px}
.gen-insight .insight-stat{font-size:20px;font-weight:700;color:#f59e0b;margin-bottom:4px}
.gen-insight .insight-text{font-size:11px;color:#94a3b8;line-height:1.4}
.risk-slide{background:linear-gradient(135deg,#7f1d1d 0%,#991b1b 50%,#0f172a 100%)}
.risk-display{display:flex;align-items:center;gap:60px;margin-bottom:40px}
.risk-circle{width:180px;height:180px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;border:8px solid}
.risk-circle .score{font-size:64px;font-weight:800}
.risk-circle .label{font-size:12px;text-transform:uppercase;letter-spacing:2px;opacity:0.7}
.risk-details{flex:1}
.risk-item{background:rgba(255,255,255,0.05);border-radius:12px;padding:20px;margin-bottom:16px}
.risk-item h4{font-size:16px;font-weight:600;margin-bottom:8px}
.risk-item p{font-size:13px;color:rgba(255,255,255,0.7)}
.action-slide{background:#0f172a}
.action-slide .headline{display:flex;align-items:center;gap:16px;margin-bottom:8px}
.action-number{width:48px;height:48px;background:#f59e0b;color:#000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;flex-shrink:0}
.action-slide .context{font-size:14px;color:#94a3b8;margin-bottom:30px}
.funding-source{display:inline-block;margin-left:16px;padding:4px 12px;background:rgba(74,222,128,0.2);color:#4ade80;border-radius:20px;font-size:11px}
.action-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
.action-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:24px}
.action-label{font-size:10px;text-transform:uppercase;letter-spacing:2px;color:#f59e0b;margin-bottom:12px}
.action-card h3{font-size:16px;font-weight:700;margin-bottom:12px}
.action-detail{font-size:12px;color:rgba(255,255,255,0.7);line-height:1.5;margin-bottom:16px}
.action-metrics{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.action-metric{background:rgba(255,255,255,0.05);border-radius:8px;padding:10px;text-align:center}
.metric-value{font-size:18px;font-weight:700;color:#4ade80}
.metric-label{font-size:9px;color:rgba(255,255,255,0.5);text-transform:uppercase}
.intel-slide{background:#0f172a}
.intel-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}
.intel-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:24px}
.intel-header{display:flex;justify-content:space-between;margin-bottom:12px}
.intel-category{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#f59e0b}
.intel-date{font-size:11px;color:#64748b}
.intel-card h4{font-size:15px;font-weight:600;margin-bottom:12px}
.intel-impact{font-size:12px;color:#94a3b8;line-height:1.5;margin-bottom:16px}
.canon-position{font-size:12px;color:#60a5fa;padding:12px;background:rgba(59,130,246,0.1);border-radius:8px}
.cta-slide{background:linear-gradient(135deg,#1e3a5f 0%,#1e40af 100%);text-align:center}
.cta-slide h2{font-size:44px;font-weight:800;margin-bottom:24px;line-height:1.2}
.cta-slide p{font-size:18px;color:rgba(255,255,255,0.8);max-width:700px;margin:0 auto 16px auto;font-weight:300}
.cta-mission{font-size:14px;color:#f59e0b;margin-bottom:40px}
.cta-buttons{display:flex;gap:20px;justify-content:center}
.cta-btn{padding:16px 36px;border-radius:8px;font-size:14px;font-weight:600;text-transform:uppercase;letter-spacing:1px;cursor:pointer;border:none}
.cta-btn.primary{background:#f59e0b;color:#000}
.cta-btn.secondary{background:transparent;border:2px solid rgba(255,255,255,0.3);color:#fff}
.page-num{position:absolute;bottom:30px;right:40px;font-size:12px;color:rgba(255,255,255,0.3)}
.data-date{position:absolute;bottom:30px;left:40px;font-size:10px;color:rgba(255,255,255,0.2)}
</style>
</head>
<body>

<!-- SLIDE 1: COVER -->
<div class="slide cover">
<div class="company">${client?.company_name || 'Company'}</div>
<h1>Workforce Health<br><span>Intelligence</span></h1>
<p class="subtitle">A data-driven view of your ${employees} employees + dependents</p>
<div class="funding-badge">${fundingType}</div>
<div class="ai-tag">‚ú¶ AI-POWERED PATTERN ANALYSIS</div>
<div class="data-date">Analysis Date: ${today} | Data: Census + Benchmarks</div>
</div>

<!-- SLIDE 2: MISSION -->
<div class="slide mission-slide">
<h2>Before We Begin</h2>
<div class="quote">"Behind every data point is a <em>person</em>‚Äîsomeone's parent,<br>someone's partner, someone who deserves to know<br>what we can see before it's too late to act."</div>
<div class="mission-values">
<div class="mission-value"><div class="icon">üëÅÔ∏è</div><h3>See Earlier</h3><p>Patterns emerge in data long before symptoms appear</p></div>
<div class="mission-value"><div class="icon">ü§ù</div><h3>Act Together</h3><p>Insights mean nothing without a path forward</p></div>
<div class="mission-value"><div class="icon">‚ù§Ô∏è</div><h3>Human First</h3><p>Putting the Human back in Human Capital</p></div>
</div>
<div class="page-num">01</div>
</div>

<!-- SLIDE 3: CENSUS PROFILE -->
<div class="slide census-slide">
<h2>Your Workforce at a Glance</h2>
<div class="headline">What the Census Reveals</div>
<div class="subhead">Before we see a single claim, your demographic data tells a powerful story</div>
<div class="census-grid">
<div class="census-stat"><div class="value blue">${employees}</div><div class="label">Enrolled Employees</div><div class="detail">+ estimated ${dependents} dependents</div></div>
<div class="census-stat"><div class="value amber">${totalLives}</div><div class="label">Total Covered Lives</div><div class="detail">Your plan's full population</div></div>
<div class="census-stat"><div class="value green">${avgAge}</div><div class="label">Average Age</div><div class="detail">${avgAge > 42 ? 'Older than' : avgAge < 42 ? 'Younger than' : 'At'} industry avg (42)</div></div>
</div>
<div class="census-insight-box"><div class="icon">üí°</div><div class="content"><h4>Key Census Insight</h4><p>${f.executive_summary || `Your workforce demographics reveal important patterns. With an average age of ${avgAge}, your population has specific health considerations that should guide benefits strategy and preventive care priorities.`}</p></div></div>
<div class="page-num">02</div>
</div>

<!-- SLIDE 4: FUNDING TYPE -->
<div class="slide funding-slide">
<h2>Your Plan Structure</h2>
<div class="headline">${fundingType}: ${isSelfFunded ? 'You Have Options' : 'Understanding Your Flexibility'}</div>
<div class="funding-card">
<div class="funding-header"><div class="funding-type">Available Resources for Health Improvement</div><div class="funding-badge-green">${isSelfFunded ? 'High Flexibility' : 'Standard Options'}</div></div>
<div class="funding-grid">
<div class="fund-box"><div class="fund-amount">$${Math.round(employees * 150).toLocaleString()}</div><div class="fund-label">Wellness Fund</div><div class="fund-desc">Screenings, challenges, education, incentives</div></div>
<div class="fund-box"><div class="fund-amount">$${Math.round(employees * 75).toLocaleString()}</div><div class="fund-label">Innovation Fund</div><div class="fund-desc">Pilot programs, new vendors, technology</div></div>
<div class="fund-box"><div class="fund-amount">$${Math.round(employees * 225).toLocaleString()}</div><div class="fund-label">Potential Savings</div><div class="fund-desc">From proactive health management</div></div>
</div>
<div style="margin-top:24px;padding:16px;background:rgba(74,222,128,0.1);border-radius:8px;text-align:center"><span style="font-size:14px;color:#4ade80"><strong>Total Available: $${Math.round(employees * 450).toLocaleString()}</strong> to invest in your people's health this year</span></div>
</div>
<div class="page-num">03</div>
</div>

<!-- SLIDE 5: GENERATIONAL OVERVIEW -->
<div class="slide gen-slide">
<h2>Your Workforce Profile</h2>
<div class="headline">Four Generations. Different Risks. One Strategy.</div>
<div class="gen-grid">
<div class="gen-card genz"><div class="gen-header"><div class="gen-name">Gen Z</div><div class="gen-pct">${genZ}%</div></div><div class="gen-meta">~${Math.round(employees * genZ / 100)} employees | Ages 18-29</div><div class="gen-insight"><div class="insight-stat">42%</div><div class="insight-text">Report anxiety/depression‚Äî3x more likely to seek help IF they know where to go</div></div><div class="gen-insight"><div class="insight-stat">67%</div><div class="insight-text">Have no established PCP‚Äîaged off parents' insurance without establishing adult care</div></div></div>
<div class="gen-card millennial"><div class="gen-header"><div class="gen-name">Millennials</div><div class="gen-pct">${mill}%</div></div><div class="gen-meta">~${Math.round(employees * mill / 100)} employees | Ages 30-44</div><div class="gen-insight"><div class="insight-stat">38%</div><div class="insight-text">Already prediabetic‚Äîmetabolic disease arriving 10 years early</div></div><div class="gen-insight"><div class="insight-stat">52%</div><div class="insight-text">Skip preventive care‚Äî"I'll do it when things calm down"</div></div></div>
<div class="gen-card genx"><div class="gen-header"><div class="gen-name">Gen X</div><div class="gen-pct">${genX}%</div></div><div class="gen-meta">~${Math.round(employees * genX / 100)} employees | Ages 45-60</div><div class="gen-insight"><div class="insight-stat">47%</div><div class="insight-text">Managing 2+ chronic conditions‚Äîthe "triple threat" cohort</div></div><div class="gen-insight"><div class="insight-stat">28%</div><div class="insight-text">Overdue for cancer screening‚Äîwhere early detection matters most</div></div></div>
<div class="gen-card boomer"><div class="gen-header"><div class="gen-name">Boomers</div><div class="gen-pct">${boom}%</div></div><div class="gen-meta">~${Math.round(employees * boom / 100)} employees | Ages 61+</div><div class="gen-insight"><div class="insight-stat">4.2</div><div class="insight-text">Average active prescriptions‚Äî23% on combinations requiring monitoring</div></div><div class="gen-insight"><div class="insight-stat">$47K</div><div class="insight-text">Average annual healthcare spend‚Äîbut 40% is influenceable</div></div></div>
</div>
<div class="page-num">04</div>
</div>

<!-- SLIDE 6: RISK ASSESSMENT -->
<div class="slide risk-slide">
<h2>Population Health Risk</h2>
<div class="headline" style="margin-bottom:40px">Risk Profile Assessment</div>
<div class="risk-display">
<div class="risk-circle" style="border-color:${riskScore < 40 ? '#22c55e' : riskScore < 70 ? '#f59e0b' : '#ef4444'}"><div class="score" style="color:${riskScore < 40 ? '#22c55e' : riskScore < 70 ? '#f59e0b' : '#ef4444'}">${riskScore}</div><div class="label">Risk Score</div></div>
<div class="risk-details">
<div class="risk-item"><h4>Risk Category: ${ra.category || (riskScore < 40 ? 'Low' : riskScore < 70 ? 'Medium' : 'High')}</h4><p>${ra.top_risk || 'Population health risks identified from demographic analysis. Key factors include age distribution, chronic disease prevalence, and preventive care gaps.'}</p></div>
${f.cost_drivers?.slice(0,2).map(d => `<div class="risk-item"><h4>${d.driver}</h4><p>Impact: ${d.impact}${d.description ? '. ' + d.description : ''}</p></div>`).join('') || '<div class="risk-item"><h4>Chronic Disease Management</h4><p>Age-related conditions require proactive monitoring and intervention strategies.</p></div>'}
</div>
</div>
<div class="page-num">05</div>
</div>

<!-- SLIDE 7: INDUSTRY INTEL -->
<div class="slide intel-slide">
<h2>Industry Intelligence</h2>
<div class="headline">What's Happening in Healthcare</div>
<div class="subhead">Our position on developments affecting your plan | Updated ${today}</div>
<div class="intel-grid">
<div class="intel-card"><div class="intel-header"><span class="intel-category">Rx Pricing</span><span class="intel-date">2025</span></div><h4>Medicare Drug Negotiation: Commercial Impact Coming</h4><div class="intel-impact">CMS finalized prices for first 10 drugs (38-79% reductions). Commercial market will feel ripple effects within 2-3 years.</div><div class="canon-position"><strong>Our Position:</strong> Proactively discuss with your PBM how Medicare reference pricing will affect commercial contracts.</div></div>
<div class="intel-card"><div class="intel-header"><span class="intel-category">Cost Trends</span><span class="intel-date">2025</span></div><h4>GLP-1s Driving 9-11% Pharmacy Trend</h4><div class="intel-impact">Medical trend 7-8%, but pharmacy is 9-11%‚Äîdriven almost entirely by GLP-1 utilization for obesity and diabetes.</div><div class="canon-position"><strong>Our Position:</strong> GLP-1s need clinically appropriate coverage WITH guardrails. Tie coverage to outcomes.</div></div>
<div class="intel-card"><div class="intel-header"><span class="intel-category">PBM Reform</span><span class="intel-date">2025</span></div><h4>FTC Report: PBMs Under Scrutiny</h4><div class="intel-impact">FTC interim report finds top 3 PBMs engaged in practices that raise costs. Several states advancing reform bills.</div><div class="canon-position"><strong>Our Position:</strong> ${isSelfFunded ? 'As a self-funded group, you can renegotiate terms. Request rebate transparency immediately.' : 'Monitor developments and discuss options with your carrier.'}</div></div>
<div class="intel-card"><div class="intel-header"><span class="intel-category">Compliance</span><span class="intel-date">2025</span></div><h4>Mental Health Parity Enforcement Tightening</h4><div class="intel-impact">DOL finalized MHPAEA rules requiring comparative analysis of MH vs. medical coverage. Enforcement begins 2025.</div><div class="canon-position"><strong>Our Position:</strong> Request MHPAEA compliance documentation from your TPA before mid-2025.</div></div>
</div>
<div class="page-num">06</div>
</div>

<!-- SLIDE 8: ACTION 1 -->
<div class="slide action-slide">
<h2>Turning Insight Into Action</h2>
<div class="headline"><div class="action-number">1</div>Cancer Screening Activation</div>
<div class="context">Based on demographics: ~${Math.round(employees * 0.6)} screening opportunities across your workforce<span class="funding-source">Wellness Fund</span></div>
<div class="action-grid">
<div class="action-card"><div class="action-label">Action A</div><h3>At-Home Colorectal Kits</h3><div class="action-detail">Mail FIT kits to all employees aged 45-75. No appointment needed. Completed at home in 5 minutes.</div><div class="action-metrics"><div class="action-metric"><div class="metric-value">${Math.round(employees * 0.4)}+</div><div class="metric-label">Eligible</div></div><div class="action-metric"><div class="metric-value">$${Math.round(employees * 0.4 * 35).toLocaleString()}</div><div class="metric-label">Est. Cost</div></div></div></div>
<div class="action-card"><div class="action-label">Action B</div><h3>Mobile Mammography Event</h3><div class="action-detail">On-site mammography unit. 15-minute appointments during work hours. No travel, no scheduling hassle.</div><div class="action-metrics"><div class="action-metric"><div class="metric-value">~${Math.round(employees * 0.22)}</div><div class="metric-label">Women Eligible</div></div><div class="action-metric"><div class="metric-value">$${Math.round(employees * 22).toLocaleString()}</div><div class="metric-label">Est. Cost</div></div></div></div>
<div class="action-card"><div class="action-label">Action C</div><h3>Birthday-Month Reminders</h3><div class="action-detail">Personalized outreach with age/gender-specific screenings due. Concierge scheduling support included.</div><div class="action-metrics"><div class="action-metric"><div class="metric-value">12</div><div class="metric-label">Monthly Campaigns</div></div><div class="action-metric"><div class="metric-value">$${Math.round(employees * 15).toLocaleString()}</div><div class="metric-label">Est. Cost</div></div></div></div>
</div>
<div class="page-num">07</div>
</div>

<!-- SLIDE 9: ACTION 2 -->
<div class="slide action-slide">
<h2>Turning Insight Into Action</h2>
<div class="headline"><div class="action-number">2</div>Diabetes Prevention Program</div>
<div class="context">Estimated ${Math.round(totalLives * 0.15)}-${Math.round(totalLives * 0.2)} prediabetic individuals across employees + dependents<span class="funding-source">Innovation Fund</span></div>
<div class="action-grid">
<div class="action-card"><div class="action-label">Action A</div><h3>CDC-Recognized DPP</h3><div class="action-detail">16-week lifestyle program with group coaching. Proven to reduce diabetes risk by 58% (RCT evidence).</div><div class="action-metrics"><div class="action-metric"><div class="metric-value">58%</div><div class="metric-label">Risk Reduction</div></div><div class="action-metric"><div class="metric-value">$500</div><div class="metric-label">Per Person</div></div></div></div>
<div class="action-card"><div class="action-label">Action B</div><h3>"Healthy Plates" Challenge</h3><div class="action-detail">4-week company-wide nutrition challenge. Team competition, subsidized meal kit partnership, weekly prizes.</div><div class="action-metrics"><div class="action-metric"><div class="metric-value">60%</div><div class="metric-label">Expected Participation</div></div><div class="action-metric"><div class="metric-value">$${Math.round(employees * 40).toLocaleString()}</div><div class="metric-label">Est. Cost</div></div></div></div>
<div class="action-card"><div class="action-label">Action C</div><h3>CGM Pilot Program</h3><div class="action-detail">Continuous glucose monitors for highest-risk prediabetics. Real-time feedback on how food affects blood sugar.</div><div class="action-metrics"><div class="action-metric"><div class="metric-value">${Math.round(employees * 0.1)}</div><div class="metric-label">Pilot Size</div></div><div class="action-metric"><div class="metric-value">$${Math.round(employees * 30).toLocaleString()}</div><div class="metric-label">3-Month Pilot</div></div></div></div>
</div>
<div class="page-num">08</div>
</div>

<!-- SLIDE 10: ACTION 3 -->
<div class="slide action-slide">
<h2>Turning Insight Into Action</h2>
<div class="headline"><div class="action-number">3</div>Mental Health Activation</div>
<div class="context">Gen Z 42% affected | Gen X caregiver burnout | Current EAP utilization ~8%<span class="funding-source">Wellness Fund</span></div>
<div class="action-grid">
<div class="action-card"><div class="action-label">Action A</div><h3>Leadership "It's OK" Campaign</h3><div class="action-detail">Senior leader shares personal story via video or town hall. Single most effective way to destigmatize. One-click EAP link in follow-up.</div><div class="action-metrics"><div class="action-metric"><div class="metric-value">2x</div><div class="metric-label">Expected EAP Uptick</div></div><div class="action-metric"><div class="metric-value">$1,500</div><div class="metric-label">Est. Cost</div></div></div></div>
<div class="action-card"><div class="action-label">Action B</div><h3>Text-Based Therapy Option</h3><div class="action-detail">Digital MH platform partnership. Texting-first approach matches how Gen Z communicates. Removes phone-call barrier.</div><div class="action-metrics"><div class="action-metric"><div class="metric-value">70%</div><div class="metric-label">Prefer Text</div></div><div class="action-metric"><div class="metric-value">$4/PEPY</div><div class="metric-label">Platform Cost</div></div></div></div>
<div class="action-card"><div class="action-label">Action C</div><h3>Manager Training Workshop</h3><div class="action-detail">2-hour session for all people managers. How to notice signs, how to ask, how to connect to resources.</div><div class="action-metrics"><div class="action-metric"><div class="metric-value">100%</div><div class="metric-label">Mgr Completion</div></div><div class="action-metric"><div class="metric-value">$${Math.round(employees * 25).toLocaleString()}</div><div class="metric-label">Est. Cost</div></div></div></div>
</div>
<div class="page-num">09</div>
</div>

<!-- SLIDE 11: CTA -->
<div class="slide cta-slide">
<h2>The Patterns Are Clear.<br>The Funds Are Available.<br>The Path Is Ready.</h2>
<p>With $${Math.round(employees * 450).toLocaleString()} in wellness, innovation, and potential savings‚Äîplus the flexibility of your ${fundingType} structure‚Äîyou have the resources to act on every insight in this report.</p>
<p class="cta-mission">Putting the Human back in Human Capital.</p>
<div class="cta-buttons">
<button class="cta-btn primary">Let's Build Your Action Plan</button>
<button class="cta-btn secondary">Request Claims Data Analysis</button>
</div>
<div class="page-num">10</div>
</div>

</body>
</html>`;
        };
        
        // Summary View
        const SummaryView = ({ findings }) => {
            const f = findings || {};
            const ra = f.risk_assessment || {};
            return (
                <div className="space-y-4">
                    {f.executive_summary && <div className="bg-gradient-to-r from-blue-600/20 to-purple-600/20 border border-blue-500/30 rounded-xl p-4"><h4 className="text-sm font-semibold text-blue-400 uppercase tracking-wider mb-2">Executive Summary</h4><p className="text-white">{f.executive_summary}</p></div>}
                    {ra.score && <div className="bg-slate-900/50 rounded-xl p-4"><h4 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Risk Assessment</h4><div className="flex items-center gap-6"><div className="text-center"><div className={`text-4xl font-bold ${ra.score < 40 ? 'text-green-400' : ra.score < 70 ? 'text-amber-400' : 'text-red-400'}`}>{ra.score}</div><div className="text-slate-500 text-sm">Risk Score</div></div><div className="flex-1 space-y-2"><div className="flex justify-between text-sm"><span className="text-slate-400">Category</span><span className="text-white">{ra.category || 'Medium'}</span></div><div className="flex justify-between text-sm"><span className="text-slate-400">Top Risk</span><span className="text-white">{ra.top_risk || '‚Äî'}</span></div></div></div></div>}
                    {f.recommendations?.length > 0 && <div className="bg-slate-900/50 rounded-xl p-4"><h4 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Recommendations</h4><div className="space-y-2">{f.recommendations.slice(0,3).map((rec, i) => <div key={i} className="bg-slate-800/50 rounded-lg p-3"><p className="text-white font-medium">{rec.action}</p><p className="text-slate-400 text-sm">{rec.timeline}</p></div>)}</div></div>}
                    {f.next_steps?.length > 0 && <div className="bg-slate-900/50 rounded-xl p-4"><h4 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Next Steps</h4><ul className="space-y-2">{f.next_steps.map((step, i) => <li key={i} className="flex items-start gap-3"><span className="w-5 h-5 bg-blue-600/20 text-blue-400 rounded-full flex items-center justify-center text-xs font-bold">{i+1}</span><span className="text-slate-300 text-sm">{step}</span></li>)}</ul></div>}
                </div>
            );
        };
        
        // Upload & Analyze
        const UploadAnalyze = ({ client, onComplete, onCancel }) => {
            const [dragOver, setDragOver] = useState(false);
            const [file, setFile] = useState(null);
            const [csvData, setCsvData] = useState(null);
            const [analyzing, setAnalyzing] = useState(false);
            const [results, setResults] = useState(null);
            const [error, setError] = useState(null);
            const [viewMode, setViewMode] = useState('summary');
            const fileInputRef = useRef(null);
            
            const processFile = (f) => {
                setFile(f); setError(null);
                const ext = f.name.split('.').pop().toLowerCase();
                if (ext === 'csv') { Papa.parse(f, { header: true, complete: (r) => setCsvData(r.data.filter(row => Object.values(row).some(v => v))), error: (e) => setError('Parse error: ' + e.message) }); }
                else if (['xlsx', 'xls'].includes(ext)) { const reader = new FileReader(); reader.onload = (e) => { try { const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' }); setCsvData(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' }).filter(row => Object.values(row).some(v => v))); } catch (err) { setError('Excel error: ' + err.message); } }; reader.readAsArrayBuffer(f); }
                else { setError('Unsupported file type'); }
            };
            
            const runAnalysis = async () => {
                if (!csvData) return; setAnalyzing(true); setError(null);
                try {
                    const csvString = Papa.unparse(csvData);
                    const { data: uploadData, error: uploadError } = await supabase.from('uploads').insert([{ client_id: client.id, file_name: file.name, file_type: file.type || 'text/csv', file_url: 'local', status: 'analyzing' }]).select().single();
                    if (uploadError) throw uploadError;
                    const response = await fetch('/.netlify/functions/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ censusData: csvString, companyName: client.company_name, employeeCount: client.employee_count, fundingType: client.funding_type, industry: client.industry }) });
                    if (!response.ok) throw new Error('Analysis request failed');
                    const result = await response.json();
                    if (!result.success) throw new Error(result.message || 'Analysis failed');
                    await supabase.from('uploads').update({ status: 'complete' }).eq('id', uploadData.id);
                    await supabase.from('analyses').insert([{ client_id: client.id, upload_id: uploadData.id, findings: result.findings, status: 'complete' }]);
                    setResults(result.findings);
                } catch (err) { setError(err.message || 'Analysis failed'); } finally { setAnalyzing(false); }
            };
            
            const downloadReport = () => { const html = generateFullReportHTML(results, client); const blob = new Blob([html], { type: 'text/html' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${client.company_name.replace(/\s+/g, '_')}_Canon_Echo_Report.html`; a.click(); };
            
            return (
                <div className="space-y-4">
                    {!results ? (
                        <>
                            <div className={`drop-zone rounded-xl p-8 text-center cursor-pointer ${dragOver ? 'drag-over' : ''}`} onDragOver={(e) => { e.preventDefault(); setDragOver(true); }} onDragLeave={() => setDragOver(false)} onDrop={(e) => { e.preventDefault(); setDragOver(false); processFile(e.dataTransfer.files[0]); }} onClick={() => fileInputRef.current?.click()}>
                                <input ref={fileInputRef} type="file" accept=".csv,.xlsx,.xls" onChange={(e) => processFile(e.target.files[0])} className="hidden" />
                                <div className="text-slate-400 mb-3">{Icons.file}</div>
                                <p className="text-white font-medium mb-1">{file ? file.name : 'Drop census file here'}</p>
                                <p className="text-slate-500 text-sm">{file ? `${csvData?.length || 0} rows` : 'CSV or Excel'}</p>
                            </div>
                            {csvData?.length > 0 && <div className="bg-slate-900/50 rounded-xl p-4"><p className="text-slate-300 text-sm">{csvData.length} rows loaded</p></div>}
                            {error && <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-red-400 text-sm">{error}</div>}
                            <div className="flex gap-3"><button onClick={onCancel} className="flex-1 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium">Cancel</button><button onClick={runAnalysis} disabled={!csvData || analyzing} className="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-600 disabled:cursor-not-allowed rounded-lg font-medium flex items-center justify-center gap-2">{analyzing ? <>{Icons.loader} Analyzing...</> : <>{Icons.sparkles} Run Analysis</>}</button></div>
                        </>
                    ) : (
                        <div className="space-y-4">
                            <div className="flex items-center justify-between">
                                <div className="flex bg-slate-800 rounded-lg p-1"><button onClick={() => setViewMode('summary')} className={`px-4 py-2 rounded-md text-sm font-medium ${viewMode === 'summary' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>Summary</button><button onClick={() => setViewMode('full')} className={`px-4 py-2 rounded-md text-sm font-medium ${viewMode === 'full' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>Full Report</button></div>
                                <button onClick={downloadReport} className="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-medium">{Icons.download} Download Full Report</button>
                            </div>
                            <div className="max-h-[60vh] overflow-y-auto">{viewMode === 'summary' ? <SummaryView findings={results} /> : <div className="bg-slate-900 rounded-xl p-6 text-center"><p className="text-white mb-4">The full 11-slide executive report is ready!</p><p className="text-slate-400 text-sm mb-4">Click "Download Full Report" to get the complete presentation including:</p><ul className="text-slate-300 text-sm text-left max-w-md mx-auto space-y-1"><li>‚Ä¢ Cover slide with company branding</li><li>‚Ä¢ Mission & values</li><li>‚Ä¢ Census profile with key stats</li><li>‚Ä¢ Funding analysis & budget</li><li>‚Ä¢ Generational breakdown</li><li>‚Ä¢ Risk assessment</li><li>‚Ä¢ Industry intelligence</li><li>‚Ä¢ 3 detailed action plans</li><li>‚Ä¢ Call to action</li></ul></div>}</div>
                            <button onClick={onComplete} className="w-full px-4 py-2.5 bg-green-600 hover:bg-green-500 rounded-lg font-medium">Done</button>
                        </div>
                    )}
                </div>
            );
        };
        
        // Analysis Detail
        const AnalysisDetail = ({ analysis, client, onClose }) => {
            const [viewMode, setViewMode] = useState('summary');
            const f = analysis.findings || {};
            const downloadReport = () => { const html = generateFullReportHTML(f, client || { company_name: 'Client', funding_type: 'Self-Funded' }); const blob = new Blob([html], { type: 'text/html' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Canon_Echo_Report.html`; a.click(); };
            return (
                <div className="fixed inset-0 z-50 flex"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative ml-auto w-full max-w-4xl bg-slate-850 border-l border-slate-700 h-full overflow-hidden animate-fade-in flex flex-col">
                        <div className="p-5 border-b border-slate-700">
                            <div className="flex items-center justify-between mb-4"><div><h2 className="text-xl font-bold text-white">Analysis Results</h2><p className="text-slate-400 text-sm mono">{new Date(analysis.created_at).toLocaleString()}</p></div><button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-lg">{Icons.close}</button></div>
                            <div className="flex items-center justify-between"><div className="flex bg-slate-800 rounded-lg p-1"><button onClick={() => setViewMode('summary')} className={`px-4 py-2 rounded-md text-sm font-medium ${viewMode === 'summary' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>Summary</button><button onClick={() => setViewMode('full')} className={`px-4 py-2 rounded-md text-sm font-medium ${viewMode === 'full' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>Full Report</button></div><button onClick={downloadReport} className="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-medium">{Icons.download} Download</button></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-5">{viewMode === 'summary' ? <SummaryView findings={f} /> : <div className="bg-slate-900 rounded-xl p-6 text-center"><p className="text-white mb-4">Click "Download" to get the complete 11-slide executive presentation.</p></div>}</div>
                    </div>
                </div>
            );
        };
        
        // Client Detail
        const ClientDetail = ({ client, uploads, analyses, onClose, onUploadAnalyze }) => {
            const clientAnalyses = analyses.filter(a => a.client_id === client.id);
            const [selectedAnalysis, setSelectedAnalysis] = useState(null);
            return (
                <div className="fixed inset-0 z-50 flex"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative ml-auto w-full max-w-2xl bg-slate-850 border-l border-slate-700 h-full overflow-y-auto animate-fade-in">
                        <div className="sticky top-0 bg-slate-850 border-b border-slate-700 p-5 flex items-center justify-between"><div><h2 className="text-xl font-bold text-white">{client.company_name}</h2><p className="text-slate-400 text-sm">{client.industry || 'No industry'} ‚Ä¢ {client.funding_type || 'No funding type'}</p></div><button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-lg">{Icons.close}</button></div>
                        <div className="p-5 space-y-6">
                            <button onClick={() => onUploadAnalyze(client)} className="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-xl font-medium flex items-center justify-center gap-2">{Icons.sparkles} Upload Census & Run Analysis</button>
                            <div className="bg-slate-900/50 rounded-xl p-4"><h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Contact</h3><div className="space-y-2"><div className="flex justify-between"><span className="text-slate-400">Name</span><span className="text-white">{client.contact_name || '‚Äî'}</span></div><div className="flex justify-between"><span className="text-slate-400">Email</span><span className="text-white">{client.contact_email || '‚Äî'}</span></div><div className="flex justify-between"><span className="text-slate-400">Employees</span><span className="text-white">{client.employee_count?.toLocaleString() || '‚Äî'}</span></div></div></div>
                            <div><h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Analyses ({clientAnalyses.length})</h3>{clientAnalyses.length === 0 ? <div className="bg-slate-900/50 rounded-xl p-6 text-center text-slate-500">No analyses yet</div> : <div className="space-y-2">{clientAnalyses.map(a => <div key={a.id} className="bg-slate-900/50 rounded-xl p-4 flex items-center justify-between cursor-pointer hover:bg-slate-800/50" onClick={() => setSelectedAnalysis(a)}><div><p className="text-white font-medium">{a.findings?.executive_summary?.substring(0,50) || 'Analysis'}...</p><p className="text-slate-500 text-sm mono">{new Date(a.created_at).toLocaleDateString()}</p></div><div className="flex items-center gap-2"><StatusBadge status={a.status} />{Icons.eye}</div></div>)}</div>}</div>
                        </div>
                    </div>
                    {selectedAnalysis && <AnalysisDetail analysis={selectedAnalysis} client={client} onClose={() => setSelectedAnalysis(null)} />}
                </div>
            );
        };
        
        // Main App
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [clients, setClients] = useState([]);
            const [uploads, setUploads] = useState([]);
            const [analyses, setAnalyses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showAddClient, setShowAddClient] = useState(false);
            const [selectedClient, setSelectedClient] = useState(null);
            const [analyzeClient, setAnalyzeClient] = useState(null);
            const [selectedAnalysis, setSelectedAnalysis] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            
            const fetchData = useCallback(async () => { setLoading(true); try { const [c, u, a] = await Promise.all([supabase.from('clients').select('*').order('created_at', { ascending: false }), supabase.from('uploads').select('*').order('uploaded_at', { ascending: false }), supabase.from('analyses').select('*').order('created_at', { ascending: false })]); setClients(c.data || []); setUploads(u.data || []); setAnalyses(a.data || []); } catch (err) { setError(err.message); } finally { setLoading(false); } }, []);
            useEffect(() => { fetchData(); }, [fetchData]);
            const handleAddClient = async (data) => { try { const { data: d, error: e } = await supabase.from('clients').insert([data]).select(); if (e) throw e; setClients([d[0], ...clients]); setShowAddClient(false); } catch (err) { alert('Error: ' + err.message); } };
            const handleDeleteClient = async (id) => { if (!confirm('Delete?')) return; try { await supabase.from('clients').delete().eq('id', id); setClients(clients.filter(c => c.id !== id)); } catch (err) { alert('Error: ' + err.message); } };
            const getClientById = (id) => clients.find(c => c.id === id);
            const filteredClients = clients.filter(c => c.company_name?.toLowerCase().includes(searchTerm.toLowerCase()));
            const stats = { totalClients: clients.length, activeClients: clients.filter(c => c.status === 'active').length, pendingUploads: uploads.filter(u => u.status === 'pending').length, completedAnalyses: analyses.filter(a => a.status === 'complete').length };
            
            return (
                <div className="min-h-screen flex">
                    <div className="w-64 bg-slate-850 border-r border-slate-700/50 flex flex-col">
                        <div className="p-5 border-b border-slate-700/50"><h1 className="text-xl font-bold text-white flex items-center gap-2"><span className="text-2xl">‚óâ</span>Canon Echo</h1><p className="text-slate-500 text-sm mt-1">Admin Dashboard</p></div>
                        <nav className="flex-1 p-3"><div className="space-y-1">{[{ id: 'dashboard', label: 'Dashboard', icon: Icons.dashboard }, { id: 'clients', label: 'Clients', icon: Icons.clients }, { id: 'uploads', label: 'Uploads', icon: Icons.uploads }, { id: 'analyses', label: 'Analyses', icon: Icons.analyses }].map(item => <button key={item.id} onClick={() => setActiveTab(item.id)} className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-left ${activeTab === item.id ? 'bg-blue-600/20 text-blue-400 border border-blue-500/30' : 'text-slate-400 hover:bg-slate-700/50'}`}>{item.icon}<span className="font-medium">{item.label}</span></button>)}</div></nav>
                        <div className="p-4 border-t border-slate-700/50"><div className="bg-slate-900/50 rounded-xl p-4"><p className="text-xs text-slate-500 uppercase mb-2">Status</p><div className="flex items-center gap-2"><div className="w-2 h-2 bg-green-500 rounded-full animate-pulse-subtle"></div><span className="text-sm text-slate-300">Online</span></div></div></div>
                    </div>
                    <div className="flex-1 overflow-auto">
                        <div className="sticky top-0 z-10 bg-slate-950/80 backdrop-blur-xl border-b border-slate-700/50 px-8 py-4"><div className="flex items-center justify-between"><h2 className="text-2xl font-bold text-white capitalize">{activeTab}</h2><div className="flex items-center gap-3"><button onClick={fetchData} className="p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg">{Icons.refresh}</button>{activeTab === 'clients' && <button onClick={() => setShowAddClient(true)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium">{Icons.plus}Add Client</button>}</div></div></div>
                        <div className="p-8">
                            {loading ? <div className="text-slate-500 text-center py-20">Loading...</div> : (
                                <>
                                    {activeTab === 'dashboard' && <div className="space-y-8"><div className="grid grid-cols-4 gap-6"><StatCard title="Total Clients" value={stats.totalClients} icon={Icons.clients} color="bg-blue-500/20 text-blue-400" /><StatCard title="Active" value={stats.activeClients} icon={Icons.check} color="bg-green-500/20 text-green-400" /><StatCard title="Pending" value={stats.pendingUploads} icon={Icons.uploads} color="bg-amber-500/20 text-amber-400" /><StatCard title="Analyses" value={stats.completedAnalyses} icon={Icons.analyses} color="bg-purple-500/20 text-purple-400" /></div><div className="grid grid-cols-2 gap-6"><div className="bg-slate-850 border border-slate-700/50 rounded-xl"><div className="p-5 border-b border-slate-700/50"><h3 className="font-semibold text-white">Recent Clients</h3></div><div className="p-2">{clients.slice(0,5).map(c => <div key={c.id} className="p-3 hover:bg-slate-700/30 rounded-lg cursor-pointer flex items-center justify-between" onClick={() => setSelectedClient(c)}><p className="text-white font-medium">{c.company_name}</p><StatusBadge status={c.status} /></div>)}</div></div><div className="bg-slate-850 border border-slate-700/50 rounded-xl"><div className="p-5 border-b border-slate-700/50"><h3 className="font-semibold text-white">Recent Analyses</h3></div><div className="p-2">{analyses.slice(0,5).map(a => <div key={a.id} className="p-3 hover:bg-slate-700/30 rounded-lg cursor-pointer flex items-center justify-between" onClick={() => setSelectedAnalysis(a)}><p className="text-white font-medium">{a.findings?.executive_summary?.substring(0,40) || 'Analysis'}...</p><StatusBadge status={a.status} /></div>)}</div></div></div></div>}
                                    {activeTab === 'clients' && <div className="space-y-6"><div className="relative"><div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-500">{Icons.search}</div><input type="text" placeholder="Search..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-slate-850 border border-slate-700 rounded-xl pl-12 pr-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500" /></div><div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-slate-700/50"><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400 uppercase">Company</th><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400 uppercase">Industry</th><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400 uppercase">Status</th><th className="text-right px-6 py-4 text-sm font-semibold text-slate-400 uppercase">Actions</th></tr></thead><tbody>{filteredClients.map((c, i) => <tr key={c.id} className={`border-b border-slate-700/30 hover:bg-slate-700/20 cursor-pointer ${i % 2 ? 'bg-slate-900/20' : ''}`} onClick={() => setSelectedClient(c)}><td className="px-6 py-4 text-white font-medium">{c.company_name}</td><td className="px-6 py-4 text-slate-300">{c.industry || '‚Äî'}</td><td className="px-6 py-4"><StatusBadge status={c.status} /></td><td className="px-6 py-4 text-right"><div className="flex items-center justify-end gap-2" onClick={e => e.stopPropagation()}><button className="p-2 text-slate-400 hover:text-blue-400 rounded-lg" onClick={() => setAnalyzeClient(c)}>{Icons.sparkles}</button><button className="p-2 text-slate-400 hover:text-red-400 rounded-lg" onClick={() => handleDeleteClient(c.id)}>{Icons.trash}</button></div></td></tr>)}</tbody></table></div></div>}
                                    {activeTab === 'uploads' && <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-slate-700/50"><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400 uppercase">File</th><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400 uppercase">Date</th><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400 uppercase">Status</th></tr></thead><tbody>{uploads.map((u, i) => <tr key={u.id} className={`border-b border-slate-700/30 ${i % 2 ? 'bg-slate-900/20' : ''}`}><td className="px-6 py-4 text-white">{u.file_name}</td><td className="px-6 py-4 text-slate-300 mono text-sm">{new Date(u.uploaded_at).toLocaleString()}</td><td className="px-6 py-4"><StatusBadge status={u.status} /></td></tr>)}</tbody></table></div>}
                                    {activeTab === 'analyses' && <div className="bg-slate-850 border border-slate-700/50 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-slate-700/50"><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400 uppercase">Summary</th><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400 uppercase">Date</th><th className="text-left px-6 py-4 text-sm font-semibold text-slate-400 uppercase">Status</th></tr></thead><tbody>{analyses.map((a, i) => <tr key={a.id} className={`border-b border-slate-700/30 hover:bg-slate-700/20 cursor-pointer ${i % 2 ? 'bg-slate-900/20' : ''}`} onClick={() => setSelectedAnalysis(a)}><td className="px-6 py-4 text-white">{a.findings?.executive_summary?.substring(0,60) || 'Analysis'}...</td><td className="px-6 py-4 text-slate-300 mono text-sm">{new Date(a.created_at).toLocaleString()}</td><td className="px-6 py-4"><StatusBadge status={a.status} /></td></tr>)}</tbody></table></div>}
                                </>
                            )}
                        </div>
                    </div>
                    <Modal isOpen={showAddClient} onClose={() => setShowAddClient(false)} title="Add Client"><AddClientForm onSubmit={handleAddClient} onCancel={() => setShowAddClient(false)} /></Modal>
                    <Modal isOpen={!!analyzeClient} onClose={() => setAnalyzeClient(null)} title={`Analyze: ${analyzeClient?.company_name || ''}`} wide>{analyzeClient && <UploadAnalyze client={analyzeClient} onComplete={() => { setAnalyzeClient(null); fetchData(); }} onCancel={() => setAnalyzeClient(null)} />}</Modal>
                    {selectedClient && <ClientDetail client={selectedClient} uploads={uploads} analyses={analyses} onClose={() => setSelectedClient(null)} onUploadAnalyze={(c) => { setSelectedClient(null); setAnalyzeClient(c); }} />}
                    {selectedAnalysis && !selectedClient && <AnalysisDetail analysis={selectedAnalysis} client={getClientById(selectedAnalysis.client_id)} onClose={() => setSelectedAnalysis(null)} />}
                </div>
            );
        };
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
